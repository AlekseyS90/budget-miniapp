<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üí∏ –õ–∏—á–Ω—ã–π –ë—é–¥–∂–µ—Ç</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* (—Ç–æ—Ç –∂–µ CSS, —á—Ç–æ –±—ã–ª) */
  </style>
</head>
<body>
  <h1>üí∏ –ú–æ–π –ë—é–¥–∂–µ—Ç</h1>
  <div class="summary">
    <div>üí∞ –ë–∞–ª–∞–Ω—Å: <span id="balance">0.00</span> ‚ÇΩ</div>
    <div>üìâ –†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü: <span id="expenses">0.00</span> ‚ÇΩ</div>
  </div>
  <button onclick="startIncome()">‚ûï –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</button>
  <button onclick="startExpense()">‚ûñ –†–∞—Å—Ö–æ–¥</button>
  <button onclick="showStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>

  <div id="form">
    <div id="categoryButtons" class="hide">
      <!-- –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    </div>
    <input id="amount" type="number" placeholder="–°—É–º–º–∞ ‚ÇΩ"/>
    <button onclick="submitForm()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    <button onclick="cancelForm()">‚ùå –û—Ç–º–µ–Ω–∞</button>
  </div>

  <div id="statsSection" class="hide">
    <select id="filterSelect" onchange="fetchStats()">
      <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
      <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
    </select>
    <canvas id="statsCanvas"></canvas>
  </div>

  <script>
    const baseURL = "https://telegrambotmany.ru/api";
    const AUTH_TOKEN = "supersecret";
    let currentType, selectedCategory, chart;

    function updateUI(b,e){
      document.getElementById("balance").textContent = b.toFixed(2);
      document.getElementById("expenses").textContent = e.toFixed(2);
    }
    function loadBalance(){
      fetch(baseURL+"/transaction",{headers:{"Authorization":"Bearer "+AUTH_TOKEN}})
        .then(r=>r.json()).then(d=>updateUI(d.balance,d.expenses))
        .catch(_=>alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞"));
    }
    function startIncome(){currentType="income"; openForm(false);}
    function startExpense(){currentType="expense"; openForm(true);}
    function openForm(showCats){
      document.getElementById("form").style.display="block";
      document.getElementById("categoryButtons").classList.toggle("hide",!showCats);
    }
    function selectCategory(c){selectedCategory=c;}
    function cancelForm(){
      document.getElementById("form").style.display="none"; selectedCategory=null;
      document.getElementById("amount").value="";
    }
    function submitForm(){
      const val = parseFloat(document.getElementById("amount").value);
      if(!val||val<=0)return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
      if(currentType==="expense"&&!selectedCategory)return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é");
      fetch(baseURL+"/transaction",{
        method:"POST", headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+AUTH_TOKEN
        },
        body:JSON.stringify({type:currentType,amount:val,category:currentType==="expense"?selectedCategory:null})
      })
      .then(r=>r.json()).then(_=>{cancelForm();loadBalance();})
      .catch(_=>alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"));
    }
    function showStats(){document.getElementById("statsSection").classList.remove("hide"); fetchStats();}
    function fetchStats(){
      const f=document.getElementById("filterSelect").value;
      fetch(baseURL+`/transaction/statistics?filter=${f}`,{
        headers:{"Authorization":"Bearer "+AUTH_TOKEN}
      })
      .then(r=>r.json())
      .then(d=>{
        const ctx=document.getElementById("statsCanvas").getContext("2d");
        const labs=Object.keys(d.expenses||{}), vals=Object.values(d.expenses||{});
        if(chart)chart.destroy();
        chart=new Chart(ctx,{type:'bar',data:{labels:labs.length?labs:["–ù–µ—Ç"],datasets:[{label:'–†–∞—Å—Ö–æ–¥—ã',data:labs.length?vals:[0],backgroundColor:['#FFB6B9']}]},options:{plugins:{legend:{display:false}}}});
      })
      .catch(_=>alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"));
    }
    loadBalance();
  </script>
</body>
</html>
